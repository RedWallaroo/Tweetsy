<html>
 <head>
   <script src="../static/d3.v3.min.js"></script>
   <script src="../static/underscore-min.js"></script>
   <script src="../static/backbone-min.js"></script>
  </head>
 <body>
  <img src="../static/tweetsy_logo_v3.png">
  <div id="container1" style="height: 500px; width: 960px"></div>
        <!-- Datamaps Source -->
        <script src="../static/datamaps-all.js"></script>
        <!--<script src="../static/maps.js"></script>-->
   <script type="text/javascript">

   json_data = {{ data|tojson|safe }}

//var bombs2 = [{"name": 'Tsar Bomb', "radius": 0, "yeild": 50000, "country": 'USSR', "fillKey": 'RUS', "significance": 'largest thremonuclear', "date": '1961-10-31', "latitude": 73.482, "longitude": 54.5854}, {"name": 'Canopus', "radius": 0, "yeild": 2600, "country": 'France', "fillKey": 'FRA', "significance": 'largest thremonuclear', "date": '1968-08-24', "latitude": -22.15, "longitude": -138.45}];

var Listing_Object = Backbone.Model.extend({
  defaults: {
    id: null,
    title: null,
    views: null,
    favorers: null,
    latitude: null,
    longitude: null,
    yields: 2000,
    radius: 0
  }
});

var Listing_Collection = Backbone.Collection.extend({
  model: Listing_Object,
  initialize: function (models,options){}
});

var Listing_Data = new Listing_Collection(json_data, { view: this })

//prep the data
    var yields = Listing_Data.pluck('yeild');
    var min = d3.min( yields );
    var max = d3.max( yields );

    var scale = d3.scale.pow()
        .domain([min, max])
        .range([10, 45]);

    Listing_Data.each(function(val, idx) {
        Listing_Data.at(idx).set('radius', scale(val.get('yeild')));
    });

   $("#container1").datamap({
        scope: 'world',
        bubbles: Listing_Data.toJSON(),
        bubble_config: {
            popupTemplate: _.template([
                '<div class="hoverinfo"><strong><%= data.title %></strong>',
                '<br/>Views: <%= data.views %>',
                '<br/>Favorers: <%= data.favorers %>',
                '<br/>Listing Id: <%= data.id %>',
                '</div>'].join(''))
        },
        geography_config: {
            popupOnHover: false,
            highlightOnHover: false
        },
        fills: {
            'USA': '#1f77b4',
            'RUS': '#9467bd',
            'PRK': '#ff7f0e',
            'PRC': '#2ca02c',
            'IND': '#e377c2',
            'GBR': '#8c564b',
            'FRA': '#d62728',
            'PAK': '#7f7f7f',
            defaultFill: '#FFFFFF'
        },
        data: {
            'RUS': {fillKey: 'RUS'},
            'PRK': {fillKey: 'PRK'},
            'CHN': {fillKey: 'PRC'},
            'IND': {fillKey: 'IND'},
            'GBR': {fillKey: 'GBR'},
            'FRA': {fillKey: 'FRA'},
            'PAK': {fillKey: 'PAK'},
            'USA': {fillKey: 'USA'}
        }
    });

de = {{ data|tojson|safe }}

d3.select("body").append("ul").selectAll("li")
  .data(de) // top level data-join
  .enter().append("li")
    .each(function() {
       var li = d3.select(this);
       li.append("p")
         .text(function(d) { return d.listing_id; });
       li.append("ul").selectAll("li")
         .data(function(d) { return d.listing_data; }) // second level data-join
           .enter().append("li")
              .text(function(d) { return "Title : " + d.listing_title; })
           .append("li")
              .text(function(d) { return "Views : " + d.views; })
           .append("li")
              .text(function(d) { return "Favorers : " + d.favorers; });
    });

   </script>
   {{ data.listing_id }}
 </body>
</html>